import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  collection, 
  onSnapshot 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Shield, Sword, Wand2, Scroll, User, Lock, CheckCircle2, AlertTriangle,
  ChevronRight, Info, Users, Star, Zap, Hammer, FlaskConical, Ghost,
  MessageSquare, Crown, Flame, Wind, Target, ShieldAlert, Dna, Ear,
  Sun, Moon, Footprints, Brain, Eye, Crosshair, HeartPulse, Sparkles
} from 'lucide-react';

// --- CONFIGURAÇÃO FIREBASE ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : { apiKey: "AIzaSyCzR5bU-ou_Cz_yxugkA2eXd_3zf86ojgw",
  authDomain: "rpg-talenttree.firebaseapp.com",
  projectId: "rpg-talenttree",
  storageBucket: "rpg-talenttree.firebasestorage.app",
  messagingSenderId: "981095423243",
  appId: "1:981095423243:web:77d651b1715e08b3d4960e",
  measurementId: "G-EEE5ZB2K8Q" };

const appId = typeof __app_id !== 'undefined' ? __app_id : 'rpg-mega-trees-v7';
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- DADOS DAS ÁRVORES (8 Árvores x 4 Habilidades x 3 Níveis) ---
const TALENT_TREES = {
  marcial: {
    title: "Senda do Guerreiro",
    icon: <Sword className="w-6 h-6" />,
    color: "bg-red-900",
    border: "border-red-500",
    description: "Domínio físico e tático. Ideal para combatentes de linha de frente.",
    talents: [
      { id: 'm1', name: "Robustez", icon: <ShieldAlert size={14}/>, levels: [
          { lv: 1, req: "Sofrer 100 de dano", effect: "+1 PV por nível.", desc: "Sua pele engrossa após cicatrizes." },
          { lv: 2, req: "Robustez I + 300 dano", effect: "+2 PV por nível.", desc: "Seu corpo ignora ferimentos superficiais." },
          { lv: 3, req: "Robustez II + Sobreviver com 1 PV", effect: "+3 PV/Lv e +1 CA.", desc: "Uma lenda que se recusa a cair." }
      ]},
      { id: 'm2', name: "Ataque Oportunista", icon: <Target size={14}/>, levels: [
          { lv: 1, req: "20 reações de ataque", effect: "Vantagem em ataques de oportunidade.", desc: "Reflexos sintonizados com a falha alheia." },
          { lv: 2, req: "Oportunista I + 10 abates", effect: "Inimigo atingido tem deslocamento 0.", desc: "Ninguém escapa do seu alcance." },
          { lv: 3, req: "Oportunista II + 50 reações", effect: "Pode fazer 2 reações por rodada.", desc: "Um turbilhão defensivo intransponível." }
      ]},
      { id: 'm3', name: "Fúria", icon: <Flame size={14}/>, levels: [
          { lv: 1, req: "HP < 50% em 5 lutas", effect: "+2 dano enquanto ferido.", desc: "A dor alimenta sua raiva." },
          { lv: 2, req: "Fúria I + 30 abates", effect: "Crítico agora é 19-20.", desc: "Golpes buscam pontos vitais." },
          { lv: 3, req: "Fúria II + Abater Chefe", effect: "Resistência a dano físico.", desc: "Sua raiva é uma armadura." }
      ]},
      { id: 'm4', name: "Comandante", icon: <Crown size={14}/>, levels: [
          { lv: 1, req: "Dar 10 comandos táticos", effect: "Aliado ganha +1 no ataque contra seu alvo.", desc: "Sua voz guia o aço aliado." },
          { lv: 2, req: "Comandante I + Flanquear 20x", effect: "Pode usar ajuda como ação bônus.", desc: "Mestre da coordenação de campo." },
          { lv: 3, req: "Comandante II + Vitória Crítica", effect: "Sua iniciativa é passada para um aliado.", desc: "Estrategista brilhante." }
      ]}
    ]
  },
  arcano: {
    title: "Caminho do Saber",
    icon: <Wand2 className="w-6 h-6" />,
    color: "bg-blue-900",
    border: "border-blue-500",
    description: "Manipulação da Trama e segredos arcanos do cosmos.",
    talents: [
      { id: 'a1', name: "Mente Clara", icon: <Zap size={14}/>, levels: [
          { lv: 1, req: "10 sucessos em concentração", effect: "Não perde concentração com dano < 10.", desc: "Mente inabalável." },
          { lv: 2, req: "Mente I + 50 magias", effect: "Vantagem em testes de resistência de INT.", desc: "Psique labiríntica." },
          { lv: 3, req: "Mente II + Meditar em plano", effect: "Pode manter 2 concentrações.", desc: "Dualidade mental." }
      ]},
      { id: 'a2', name: "Tecelão", icon: <Wind size={14}/>, levels: [
          { lv: 1, req: "Gastar 30 slots lv 1+", effect: "Recupera 1 slot lv 1 em descanso curto.", desc: "Reciclagem de energia." },
          { lv: 2, req: "Tecelão I + Aprender 5 magias", effect: "Pode trocar uma magia preparada.", desc: "Versatilidade mágica." },
          { lv: 3, req: "Tecelão II + Slot lv 5", effect: "Conjura lv 1 sem slot 3x/dia.", desc: "A magia flui livremente." }
      ]},
      { id: 'a3', name: "Potência", icon: <Flame size={14}/>, levels: [
          { lv: 1, req: "200 dano mágico", effect: "Rola 1s no dano novamente.", desc: "Máximo impacto mágico." },
          { lv: 2, req: "Potência I + 50 abates", effect: "Ignora resistências elementais.", desc: "O fogo queima até o fogo." },
          { lv: 3, req: "Potência II + Crítico", effect: "+1 dado de dano em magias.", desc: "Destruição absoluta." }
      ]},
      { id: 'a4', name: "Metamagia", icon: <Sparkles size={14}/>, levels: [
          { lv: 1, req: "Modificar 10 magias", effect: "Pode dobrar o alcance de uma magia (3x/dia).", desc: "Sua vontade estica a trama." },
          { lv: 2, req: "Metamagia I + Usar 3 elementos", effect: "Magias de alvo único atingem 2 alvos próximos.", desc: "Magia duplicada." },
          { lv: 3, req: "Metamagia II + Desvendar selo", effect: "Remove componentes verbais de qualquer magia.", desc: "Conjunção silenciosa." }
      ]}
    ]
  },
  divino: {
    title: "Senda Divina",
    icon: <Sun className="w-6 h-6" />,
    color: "bg-amber-900",
    border: "border-amber-400",
    description: "Conexão com deuses e luz sagrada. Cura e punição divina.",
    talents: [
      { id: 'd1', name: "Cura Sagrada", icon: <HeartPulse size={14}/>, levels: [
          { lv: 1, req: "Curar 200 PV", effect: "Dados de cura rolam +1.", desc: "Suas mãos brilham com calor divino." },
          { lv: 2, req: "Cura I + Estabilizar 10 aliados", effect: "Curas removem a condição 'Cego' ou 'Surdo'.", desc: "Milagre restaurador." },
          { lv: 3, req: "Cura II + Ressuscitar alguém", effect: "Sempre cura o valor máximo em aliados com < 50% HP.", desc: "O ápice da benevolência." }
      ]},
      { id: 'd2', name: "Escudo da Fé", icon: <Shield size={14}/>, levels: [
          { lv: 1, req: "Bloquear dano para aliado", effect: "Aliados a 3m ganham +1 CA.", desc: "Sua fé é um domo protetor." },
          { lv: 2, req: "Escudo I + Resistir a 20 feitiços", effect: "Resistência a dano Necrótico.", desc: "A luz repele a morte." },
          { lv: 3, req: "Escudo II + Banir demônio", effect: "Dano recebido por aliados próximos é dividido com você.", desc: "Mártir sagrado." }
      ]},
      { id: 'd3', name: "Luz Punidora", icon: <Zap size={14}/>, levels: [
          { lv: 1, req: "Abater 10 mortos-vivos", effect: "+1d6 dano Radiante em ataques mágicos.", desc: "A escuridão foge de você." },
          { lv: 2, req: "Luz I + Cegar 5 inimigos", effect: "Alvos atingidos ficam impedidos de usar reações.", desc: "Clarão paralisante." },
          { lv: 3, req: "Luz II + Purificar solo", effect: "Crítico contra profanos causa explosão de luz.", desc: "Julgamento final." }
      ]},
      { id: 'd4', name: "Intercessão", icon: <MessageSquare size={14}/>, levels: [
          { lv: 1, req: "Rezar por 30 turnos", effect: "Pode gastar reação para dar vantagem em teste de resistência.", desc: "Ouvido por forças maiores." },
          { lv: 2, req: "Intercessão I + 10 milagres", effect: "O deuso responde 1 pergunta por dia (Sim/Não).", desc: "Comunhão direta." },
          { lv: 3, req: "Intercessão II + Salvar Vila", effect: "Pode invocar um Avatar por 1 turno (1x/mês).", desc: "Voz do panteão." }
      ]}
    ]
  },
  sombras: {
    title: "Senda das Sombras",
    icon: <Moon className="w-6 h-6" />,
    color: "bg-slate-900",
    border: "border-indigo-500",
    description: "Infiltração, assassinato e manipulação do breu.",
    talents: [
      { id: 'sh1', name: "Lâmina Tóxica", icon: <FlaskConical size={14}/>, levels: [
          { lv: 1, req: "Envenenar 10 alvos", effect: "Armas causam +1d4 veneno (1min após aplicar).", desc: "O aço que arde." },
          { lv: 2, req: "Lâmina I + Extrair veneno", effect: "O veneno agora causa a condição 'Lento'.", desc: "Toxina debilitante." },
          { lv: 3, req: "Lâmina II + Matar Rei", effect: "Ignora imunidade a veneno de criaturas vivas.", desc: "Veneno da viúva negra." }
      ]},
      { id: 'sh2', name: "Furtividade Ativa", icon: <Ghost size={14}/>, levels: [
          { lv: 1, req: "Passar despercebido 20x", effect: "Inimigos têm -5 na Percepção Passiva contra você.", desc: "Um borrão na visão." },
          { lv: 2, req: "Furtividade I + Roubar joia", effect: "Pode se esconder mesmo sob observação leve.", desc: "Mimetismo sombrio." },
          { lv: 3, req: "Furtividade II + Invadir Plano", effect: "Fica invisível por 1 turno após matar um alvo.", desc: "O espectro da morte." }
      ]},
      { id: 'sh3', name: "Ataque Brutal", icon: <Crosshair size={14}/>, levels: [
          { lv: 1, req: "15 ataques com vantagem", effect: "Ataque surpresa dá +2d6 dano.", desc: "Onde dói mais." },
          { lv: 2, req: "Brutal I + 10 críticos", effect: "Se o alvo estiver com 100% HP, o ataque é crítico automático.", desc: "Primeiro e último golpe." },
          { lv: 3, req: "Brutal II + Abate silencioso", effect: "Triplica o dano em ataques contra alvos surpresos.", desc: "Execução perfeita." }
      ]},
      { id: 'sh4', name: "Agilidade Oculta", icon: <Footprints size={14}/>, levels: [
          { lv: 1, req: "Esquivar de 30 ataques", effect: "Desengajar é ação livre.", desc: "Enguia humana." },
          { lv: 2, req: "Agilidade I + Saltar 50m", effect: "Pode escalar qualquer superfície sem teste.", desc: "Passos de aranha." },
          { lv: 3, req: "Agilidade II + Cair de 20m", effect: "Recebe 0 dano de queda (até 30m).", desc: "Pouso de folha." }
      ]}
    ]
  },
  sobrevivencia: {
    title: "Instinto Selvagem",
    icon: <Shield className="w-6 h-6" />,
    color: "bg-emerald-900",
    border: "border-emerald-500",
    description: "Resiliência da natureza e adaptação extrema.",
    talents: [
      { id: 's1', name: "Pele de Carvalho", icon: <Dna size={14}/>, levels: [
          { lv: 1, req: "Cair para 0 PV 3x", effect: "Mod. Con na CA (sem armadura).", desc: "Corpo moldado pela dor." },
          { lv: 2, req: "Pele I + Comer monstro", effect: "Resistência a Veneno.", desc: "Sangue antídoto." },
          { lv: 3, req: "Pele II + Sobreviver queda", effect: "RD 3 contra concussão.", desc: "Ossos de ferro." }
      ]},
      { id: 's2', name: "Rastreador", icon: <Target size={14}/>, levels: [
          { lv: 1, req: "Achar 10 pistas", effect: "Vantagem em Sobrevivência.", desc: "O chão conta histórias." },
          { lv: 2, req: "Rastreador I + Noite selva", effect: "Visão Escuro +18m.", desc: "Olhos de lobo." },
          { lv: 3, req: "Rastreador II + Direção", effect: "Sempre sabe onde está água e o norte.", desc: "Bússola biológica." }
      ]},
      { id: 's3', name: "Adaptação", icon: <Zap size={14}/>, levels: [
          { lv: 1, req: "Dano elemental", effect: "Reduz dano Fogo/Gelo em 2.", desc: "Ajuste térmico." },
          { lv: 2, req: "Adaptação I + 5 resists", effect: "Respira sob água por 1h.", desc: "Pulmões anfíbios." },
          { lv: 3, req: "Adaptação II + Viagem", effect: "Resistência elemental trocável em descanso longo.", desc: "Mimetismo total." }
      ]},
      { id: 's4', name: "Mestre das Feras", icon: <Ear size={14}/>, levels: [
          { lv: 1, req: "Domar 3 animais", effect: "Pode entender emoções de animais.", desc: "Empatia selvagem." },
          { lv: 2, req: "Feras I + Combate com pet", effect: "Pode usar os sentidos do seu animal (100m).", desc: "Olhos da águia." },
          { lv: 3, req: "Feras II + Salvar espécie", effect: "Pode invocar um enxame para ajudar (1x/dia).", desc: "Chamado da matilha." }
      ]}
    ]
  },
  utilidade: {
    title: "Mestre de Ofícios",
    icon: <Scroll className="w-6 h-6" />,
    color: "bg-amber-800",
    border: "border-amber-500",
    description: "Conhecimento técnico, suporte e criação.",
    talents: [
      { id: 'u1', name: "Alquimia", icon: <FlaskConical size={14}/>, levels: [
          { lv: 1, req: "20 ervas", effect: "Cria 2 poções cura/dia.", desc: "Misturas básicas." },
          { lv: 2, req: "Alquimia I + 10 poções", effect: "Poções curam valor máximo.", desc: "Pureza absoluta." },
          { lv: 3, req: "Alquimia II + Veneno", effect: "Cria antídotos universais.", desc: "Apotecário lendário." }
      ]},
      { id: 'u2', name: "Ferraria", icon: <Hammer size={14}/>, levels: [
          { lv: 1, req: "30 itens reparados", effect: "Armas aliadas +1 dano.", desc: "Manutenção de mestre." },
          { lv: 2, req: "Ferraria I + Forjar aço", effect: "Reforça armadura (+1 CA tempo).", desc: "Forja de campo." },
          { lv: 3, req: "Ferraria II + Forja lend", effect: "Equipamento não quebra.", desc: "Aço eterno." }
      ]},
      { id: 'u3', name: "Ladinagem", icon: <Ghost size={14}/>, levels: [
          { lv: 1, req: "15 trancas", effect: "Dobro de proficiência Gazuas.", desc: "Mãos leves." },
          { lv: 2, req: "Ladinagem I + Furtar", effect: "Esconde-se como bônus.", desc: "Fantasma." },
          { lv: 3, req: "Ladinagem II + Invadir", effect: "Não ativa armadilhas mecânicas.", desc: "Sombra." }
      ]},
      { id: 'u4', name: "Liderança", icon: <Crown size={14}/>, levels: [
          { lv: 1, req: "30 ajudas", effect: "Ação ajudar dá +1d6.", desc: "Incentivo tático." },
          { lv: 2, req: "Liderança I + Vitória", effect: "Aliados +3m deslocamento.", desc: "Comandante nato." },
          { lv: 3, req: "Liderança II + 100 ajudas", effect: "Vantagem em saves para aliados próximos.", desc: "Farol de esperança." }
      ]}
    ]
  },
  primal: {
    title: "Senda Primal",
    icon: <Flame className="w-6 h-6" />,
    color: "bg-orange-950",
    border: "border-orange-500",
    description: "Conexão elemental bruta e instintos ancestrais de destruição.",
    talents: [
      { id: 'p1', name: "Mimetismo Terra", icon: <Shield size={14}/>, levels: [
          { lv: 1, req: "Enterrado vivo", effect: "Ganha 5 PV temporários ao tocar o solo.", desc: "Pés firmes na terra." },
          { lv: 2, req: "Terra I + 10 abates pedra", effect: "Não pode ser derrubado (prone).", desc: "Estabilidade de montanha." },
          { lv: 3, req: "Terra II + Escavar túnel", effect: "Corpo de pedra: RD 5 contra físico.", desc: "Monólito vivo." }
      ]},
      { id: 'p2', name: "Sopro de Fogo", icon: <Flame size={14}/>, levels: [
          { lv: 1, req: "Sobreviver fogo", effect: "Ataques causam +1 fogo.", desc: "Brasas nas veias." },
          { lv: 2, req: "Fogo I + 50 dano chamas", effect: "Resistência a Fogo.", desc: "Pele de salamandra." },
          { lv: 3, req: "Fogo II + Queimar floresta", effect: "Pode lançar Mãos Flamejantes 3x/dia.", desc: "Dragão em forma humana." }
      ]},
      { id: 'p3', name: "Velocidade Vento", icon: <Wind size={14}/>, levels: [
          { lv: 1, req: "Correr 1km em combate", effect: "+1.5m deslocamento.", desc: "Leve como a brisa." },
          { lv: 2, req: "Vento I + Esquivar flecha", effect: "Ataques à distância contra você têm desvantagem.", desc: "Desvio aerodinâmico." },
          { lv: 3, req: "Vento II + Cair de nuvem", effect: "Pode levitar por 1 minuto (1x/dia).", desc: "Filho do vendaval." }
      ]},
      { id: 'p4', name: "Chamado Mar", icon: <Zap size={14}/>, levels: [
          { lv: 1, req: "Nadar 500m", effect: "Deslocamento de natação igual ao normal.", desc: "Fluidez aquática." },
          { lv: 2, req: "Mar I + Pescar monstro", effect: "Ataques causam +1d4 raio na água.", desc: "Corrente elétrica." },
          { lv: 3, req: "Mar II + Sobreviver abismo", effect: "Pode respirar água e falar com peixes.", desc: "Avatar das profundezas." }
      ]}
    ]
  },
  mental: {
    title: "Senda Mental",
    icon: <Brain className="w-6 h-6" />,
    color: "bg-purple-950",
    border: "border-purple-400",
    description: "Poderes psíquicos e manipulação da consciência.",
    talents: [
      { id: 'ps1', name: "Telecinese", icon: <Zap size={14}/>, levels: [
          { lv: 1, req: "Mover 50 objetos", effect: "Mãos Mágicas invisíveis permanentes.", desc: "Mente sobre matéria." },
          { lv: 2, req: "Ps1 + Empurrar gigante", effect: "Pode empurrar inimigo 3m com ação bônus.", desc: "Pulso cinético." },
          { lv: 3, req: "Ps2 + Levitar casa", effect: "Pode paralisar um alvo por 1 turno (1x/descanso).", desc: "Prisão mental." }
      ]},
      { id: 'ps2', name: "Leitura Mental", icon: <Eye size={14}/>, levels: [
          { lv: 1, req: "Vencer 20 testes Intuição", effect: "Pode sentir a presença de mentes a 9m.", desc: "Sussurros de pensamentos." },
          { lv: 2, req: "Ps1 + Detectar mentira", effect: "Vantagem em testes contra ilusões.", desc: "Visão além do véu." },
          { lv: 3, req: "Ps2 + Dominar mente", effect: "Pode lançar 'Sugestão' 1x por descanso longo.", desc: "Manipulador de sonhos." }
      ]},
      { id: 'ps3', name: "Escudo Psíquico", icon: <Shield size={14}/>, levels: [
          { lv: 1, req: "Dano Psíquico sofrido", effect: "Resistência a dano Psíquico.", desc: "Muralha cerebral." },
          { lv: 2, req: "Ps1 + Bloquear controle", effect: "Imunidade a ser Enfeitiçado (Charmed).", desc: "Vontade de ferro." },
          { lv: 3, req: "Ps2 + Refletir dor", effect: "Dano mental sofrido é refletido ao atacante.", desc: "Espelho cognitivo." }
      ]},
      { id: 'ps4', name: "Salto Espacial", icon: <Footprints size={14}/>, levels: [
          { lv: 1, req: "Caminhar 100km", effect: "Pode se teleportar 1.5m em vez de andar.", desc: "Passo dimensional." },
          { lv: 2, req: "Ps1 + Teleporte cego", effect: "Pode usar 'Passo Misterioso' 1x/descanso.", desc: "Fenda na realidade." },
          { lv: 3, req: "Ps2 + Viajar planos", effect: "Pode trocar de lugar com um aliado (ação bônus).", desc: "Troca quântica." }
      ]}
    ]
  }
};

export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login'); 
  const [characterName, setCharacterName] = useState('');
  const [characterData, setCharacterData] = useState(null);
  const [allCharacters, setAllCharacters] = useState([]);
  const [loading, setLoading] = useState(true);
  const [tooltip, setTooltip] = useState({ show: false, content: null, x: 0, y: 0 });

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    onAuthStateChanged(auth, setUser);
    setLoading(false);
  }, []);

  useEffect(() => {
    if (!user) return;
    
    let unsubChar = () => {};
    if (characterName && characterName.toLowerCase() !== 'mestre') {
      const charRef = doc(db, 'artifacts', appId, 'public', 'data', 'characters', characterName.toLowerCase());
      unsubChar = onSnapshot(charRef, (snap) => {
        if (snap.exists()) setCharacterData(snap.data());
        else setDoc(charRef, { name: characterName, selectedTree: null, unlocked: {} });
      });
    }

    const q = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
    const unsubAll = onSnapshot(q, (snap) => {
      const chars = [];
      snap.forEach(d => chars.push(d.data()));
      setAllCharacters(chars);
    });

    return () => { unsubChar(); unsubAll(); };
  }, [user, characterName]);

  const saveCharacter = async (id, data) => {
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', id.toLowerCase()), data);
  };

  const upgradeTalent = (talentId, level) => {
    const currentUnlocked = characterData.unlocked || {};
    const currentLv = currentUnlocked[talentId] || 0;
    if (level === currentLv + 1) {
      const updated = { ...characterData, unlocked: { ...currentUnlocked, [talentId]: level } };
      saveCharacter(characterName, updated);
    } else if (level === currentLv) {
      const updated = { ...characterData, unlocked: { ...currentUnlocked, [talentId]: level - 1 } };
      saveCharacter(characterName, updated);
    }
  };

  const showTooltip = (e, talentName, levelData) => {
    setTooltip({ show: true, content: { ...levelData, talentName }, x: e.clientX, y: e.clientY });
  };

  if (loading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-amber-500 font-black italic animate-pulse tracking-widest">INVOCANDO GRIMÓRIO...</div>;

  if (view === 'login') return (
    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
      <div className="bg-slate-900 border-2 border-slate-800 p-10 rounded-[3rem] w-full max-w-sm shadow-2xl relative overflow-hidden group">
        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent group-hover:scale-x-150 transition-transform duration-1000"></div>
        <div className="flex justify-center mb-8"><Scroll className="w-16 h-16 text-amber-600 drop-shadow-lg" /></div>
        <h1 className="text-3xl font-black text-center text-white mb-2 tracking-tighter uppercase italic">Suporte RPG 5e</h1>
        <p className="text-slate-500 text-center text-[10px] mb-10 uppercase font-bold tracking-[0.3em]">O Despertar do Nível 4</p>
        <form onSubmit={(e) => { e.preventDefault(); setView(characterName.toLowerCase() === 'mestre' ? 'master' : 'character'); }} className="space-y-4">
          <input 
            type="text" placeholder="Nome do Personagem" 
            className="w-full bg-slate-800 border-slate-700 rounded-2xl p-4 text-white outline-none focus:ring-2 focus:ring-amber-500 transition-all font-bold"
            onChange={e => setCharacterName(e.target.value)}
          />
          <button className="w-full bg-amber-600 hover:bg-amber-500 text-white font-black p-4 rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-widest shadow-lg shadow-amber-900/20 active:scale-95">
            Entrar no Reino <ChevronRight />
          </button>
        </form>
      </div>
    </div>
  );

  // --- VIEW: MESTRE (Guia de Perks Detalhada) ---
  if (view === 'master') return (
    <div className="min-h-screen bg-slate-950 text-slate-100 p-6">
      <header className="max-w-6xl mx-auto flex justify-between items-center mb-10 border-b border-slate-800 pb-6">
        <h1 className="text-3xl font-black flex items-center gap-3 italic uppercase tracking-tighter"><Users className="text-amber-500" /> Sala do Mestre</h1>
        <button onClick={() => setView('login')} className="bg-slate-800 px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest border border-slate-700 hover:bg-slate-700">Voltar</button>
      </header>
      <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {allCharacters.map(char => {
          const tree = char.selectedTree ? TALENT_TREES[char.selectedTree] : null;
          return (
            <div key={char.name} className="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-8 hover:border-amber-500/30 transition-all shadow-xl relative overflow-hidden group">
              <div className="flex items-center gap-4 mb-6 border-b border-slate-800 pb-4">
                <div className="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center text-amber-500 font-black text-xl shadow-inner border border-slate-700">{char.name[0]}</div>
                <div>
                  <h3 className="text-2xl font-black uppercase tracking-tight text-white">{char.name}</h3>
                  <p className="text-[10px] text-amber-600 font-bold tracking-widest uppercase">{tree ? tree.title : "Iniciante"}</p>
                </div>
              </div>
              <div className="space-y-4">
                <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2"><Zap size={10}/> Perks Conquistados:</h4>
                <div className="grid gap-3">
                  {Object.entries(char.unlocked || {}).map(([talentId, level]) => {
                    if (level === 0) return null;
                    const talentData = tree?.talents.find(t => t.id === talentId);
                    const levelInfo = talentData?.levels[level - 1];
                    return (
                      <div key={talentId} className="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-[11px] font-black text-slate-200 uppercase flex items-center gap-2">
                             {talentData?.icon} {talentData?.name} - NV {level}
                          </span>
                          <Star size={10} className="text-amber-500 fill-amber-500" />
                        </div>
                        <p className="text-[11px] text-green-400 font-black leading-tight mb-1">{levelInfo?.effect}</p>
                        <p className="text-[10px] text-slate-500 italic">"{levelInfo?.desc}"</p>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  // --- VIEW: JOGADOR ---
  const charTree = characterData?.selectedTree ? TALENT_TREES[characterData.selectedTree] : null;

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 pb-20 relative">
      {tooltip.show && (
        <div 
          className="fixed z-[100] pointer-events-none bg-slate-900 border border-slate-700 p-5 rounded-3xl shadow-[0_0_50px_rgba(0,0,0,0.8)] w-72 animate-in fade-in zoom-in-95"
          style={{ left: tooltip.x + 20, top: tooltip.y + 20 }}
        >
          <div className="flex items-center gap-2 mb-2">
             <Star className="w-4 h-4 text-amber-500 fill-amber-500" />
             <p className="text-amber-500 font-black uppercase text-xs tracking-tighter">{tooltip.content.talentName} {tooltip.content.lv ? `- NV ${tooltip.content.lv}` : ""}</p>
          </div>
          <p className="text-[11px] text-slate-400 italic mb-4 leading-relaxed">"{tooltip.content.desc}"</p>
          <div className="space-y-3 border-t border-slate-800 pt-3 text-[10px]">
            <div className="bg-red-950/20 p-2 rounded-lg border border-red-900/30">
               <p className="font-black text-slate-500 uppercase tracking-widest mb-1">Desafio Requerido:</p>
               <p className="text-red-400 font-bold">{tooltip.content.req}</p>
            </div>
            <div className="bg-green-950/20 p-2 rounded-lg border border-green-900/30">
               <p className="font-black text-slate-500 uppercase tracking-widest mb-1">Efeito Recebido:</p>
               <p className="text-green-400 font-black">{tooltip.content.effect}</p>
            </div>
          </div>
        </div>
      )}

      <header className="bg-slate-900/90 backdrop-blur-xl border-b border-slate-800 p-6 sticky top-0 z-40">
        <div className="max-w-6xl mx-auto flex justify-between items-center px-4">
          <div className="flex items-center gap-5">
            <div className="bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-inner"><User className="text-amber-500" /></div>
            <div>
              <h2 className="text-3xl font-black uppercase tracking-tighter text-white drop-shadow-md">{characterData?.name}</h2>
              <div className="flex items-center gap-2">
                 <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_green]"></div>
                 <p className="text-slate-500 text-[10px] font-bold tracking-[0.2em] uppercase italic">Destino Aberto • Nível 4</p>
              </div>
            </div>
          </div>
          <button onClick={() => setView('login')} className="text-slate-500 hover:text-white text-[10px] font-black uppercase tracking-widest border border-slate-800 px-5 py-2 rounded-xl transition-all hover:bg-slate-800">Trocar Herói</button>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 space-y-12 mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {!charTree && (
          <div className="col-span-full bg-gradient-to-br from-amber-900/30 to-slate-900 border border-amber-500/40 rounded-[3rem] p-10 flex items-start gap-8 shadow-2xl relative overflow-hidden group">
            <div className="absolute -right-10 -top-10 opacity-5 rotate-12 group-hover:rotate-45 transition-all duration-1000"><Scroll size={200} /></div>
            <AlertTriangle className="text-amber-500 shrink-0 w-10 h-10 mt-1" />
            <div className="relative z-10">
              <h3 className="text-2xl font-black text-amber-500 mb-2 uppercase tracking-tight italic">O Despertar da Vocação</h3>
              <p className="text-slate-400 text-sm leading-relaxed max-w-2xl">
                O nível 4 marca o início da sua especialização. Escolha uma das **Oito Vertentes do Destino**. 
                Cada árvore desbloqueia 4 talentos únicos com 3 níveis de evolução. 
                <span className="block mt-4 text-white font-black underline decoration-amber-500 uppercase italic">A escolha é permanente e selará as outras árvores para sempre nesta ficha.</span>
              </p>
            </div>
          </div>
        )}

        {Object.entries(TALENT_TREES).map(([key, tree]) => {
          const isSelected = characterData?.selectedTree === key;
          const isBlocked = characterData?.selectedTree && !isSelected;

          return (
            <div 
              key={key}
              className={`
                relative bg-slate-900 rounded-[3.5rem] border-2 p-10 transition-all duration-500 group flex flex-col h-full
                ${isSelected ? `${tree.border} shadow-[0_0_80px_rgba(0,0,0,0.6)] scale-[1.03] z-10` : 'border-slate-800'}
                ${isBlocked ? 'opacity-10 grayscale scale-90 pointer-events-none blur-[1px]' : 'hover:border-slate-500 cursor-pointer'}
              `}
              onClick={() => !isSelected && !isBlocked && saveCharacter(characterName, { ...characterData, selectedTree: key })}
            >
              <div 
                className="flex items-center gap-5 mb-8"
                onMouseEnter={(e) => showTooltip(e, tree.title, { desc: tree.description, req: "Evolução Irreversível", effect: "Acesso total aos talentos da vertente." })}
                onMouseLeave={() => setTooltip({ ...tooltip, show: false })}
              >
                <div className={`${tree.color} p-5 rounded-3xl shadow-xl transition-all group-hover:rotate-6 group-hover:scale-110 border border-white/5`}>{tree.icon}</div>
                <h3 className="text-2xl font-black uppercase tracking-tighter text-white group-hover:text-amber-500 transition-colors italic">{tree.title}</h3>
              </div>

              {isSelected ? (
                <div className="space-y-10 animate-in fade-in slide-in-from-bottom-8 flex-grow">
                  <div className="flex items-center gap-3 text-green-500 text-[10px] font-black uppercase tracking-[0.3em] bg-green-950/20 w-fit px-5 py-2 rounded-full border border-green-500/20">
                    <CheckCircle2 size={14}/> Sincronizado
                  </div>
                  <div className="grid gap-8">
                  {tree.talents.map(talent => (
                    <div key={talent.id} className="space-y-4">
                      <div className="flex justify-between items-center bg-slate-950/40 p-4 rounded-2xl border border-slate-800/50 shadow-inner">
                        <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-3 italic">
                           {talent.icon} {talent.name}
                        </h4>
                        <Info size={14} className="text-slate-700 hover:text-amber-500 cursor-help transition-colors" />
                      </div>
                      <div className="flex gap-3">
                        {talent.levels.map(level => {
                          const currentUnlocked = characterData.unlocked?.[talent.id] || 0;
                          const isAtivo = currentUnlocked >= level.lv;
                          const isDisponivel = level.lv === currentUnlocked + 1;
                          return (
                            <button
                              key={level.lv}
                              onMouseEnter={(e) => showTooltip(e, talent.name, level)}
                              onMouseLeave={() => setTooltip({ ...tooltip, show: false })}
                              onClick={(e) => { e.stopPropagation(); (isAtivo || isDisponivel) && upgradeTalent(talent.id, level.lv); }}
                              className={`
                                flex-1 py-4 rounded-[1.5rem] font-black text-sm transition-all border-2
                                ${isAtivo ? `${tree.color} border-transparent text-white shadow-xl scale-[1.05]` : 
                                  isDisponivel ? `bg-slate-800 border-slate-700 text-slate-500 hover:${tree.border} hover:text-white shadow-lg` : 
                                  'bg-slate-950 border-transparent text-slate-800 cursor-not-allowed'}
                              `}
                            >
                              {level.lv === 1 ? 'I' : level.lv === 2 ? 'II' : 'III'}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                  </div>
                </div>
              ) : (
                <div className="space-y-8 flex-grow">
                  <p className="text-sm text-slate-500 leading-relaxed italic pr-4">"{tree.description}"</p>
                  <div className="mt-auto bg-slate-950/50 p-6 rounded-[2rem] border border-slate-800 text-center uppercase group-hover:border-amber-500/40 transition-all">
                    <span className="text-[10px] font-black text-amber-500 tracking-[0.3em] group-hover:text-amber-400">Selar Trilha</span>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </main>
    </div>
  );
}
